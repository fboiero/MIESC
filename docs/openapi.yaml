openapi: 3.1.0
info:
  title: MIESC API
  description: |
    # MIESC - Multi-layer Intelligent Evaluation for Smart Contracts

    ML-enhanced MCP-compatible blockchain security framework API.

    ## Features
    - Smart contract security analysis with 7-layer defense-in-depth
    - ML-powered false positive filtering and severity prediction
    - Smart Correlation Engine for cross-tool validation
    - Exploit Chain Analysis for attack path detection
    - Automated remediation suggestions with fix plans
    - MCP (Model Context Protocol) compatibility

    ## Scientific Validation (SmartBugs Benchmark)
    - Precision: 89.47%
    - Recall: 100% (SmartBugs detectors)
    - F1-Score: 87.81%
    - Cohen's Kappa: 0.847
    - Dataset: 5,127 contracts

    ## Frameworks Compliance
    - ISO/IEC 27001:2022
    - ISO/IEC 42001:2023
    - NIST SP 800-218 (SSDF)
    - OWASP SAMM v2.0
    - OWASP Smart Contract Top 10
    - Digital Public Good (DPG) Standards

  version: "4.1.0"
  contact:
    name: Fernando Boiero
    email: fboiero@frvm.utn.edu.ar
  license:
    name: GPL-3.0
    url: https://www.gnu.org/licenses/gpl-3.0.html
    identifier: GPL-3.0-only

servers:
  - url: http://localhost:5001
    description: Local development server
  - url: http://localhost:8000
    description: Docker API server

tags:
  - name: MCP
    description: Model Context Protocol endpoints
  - name: MCP Tools
    description: MCP Tool Discovery (tools/list, tools/call)
  - name: Analysis
    description: Smart contract analysis endpoints
  - name: Correlation
    description: Cross-tool correlation and exploit chain analysis
  - name: Remediation
    description: Vulnerability remediation suggestions
  - name: DeFi
    description: DeFi-specific security analysis
  - name: Persistence
    description: Audit history and findings storage (SQLite)
  - name: Compliance
    description: CWE→ISO 27001→NIST CSF compliance mapping
  - name: Health
    description: System health and status
  - name: Export
    description: Export findings to SARIF, SonarQube, Checkmarx, Markdown, JSON
  - name: Observability
    description: Prometheus metrics and system observability
  - name: WebSocket
    description: Real-time WebSocket API for live audit updates

paths:
  /:
    get:
      tags:
        - Health
      summary: Root endpoint
      description: Returns basic API information and available endpoints
      operationId: getRoot
      responses:
        '200':
          description: API information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RootResponse'

  /mcp/capabilities:
    get:
      tags:
        - MCP
      summary: Get MCP capabilities
      description: Lists all available MCP capabilities and metadata
      operationId: getCapabilities
      responses:
        '200':
          description: MCP capabilities
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CapabilitiesResponse'

  /mcp/status:
    get:
      tags:
        - Health
      summary: Get agent status
      description: Returns current health status of the MIESC agent
      operationId: getStatus
      responses:
        '200':
          description: Agent status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'

  # ==========================================================================
  # MCP TOOL DISCOVERY (v4.1.0)
  # ==========================================================================
  /mcp/tools/list:
    get:
      tags:
        - MCP Tools
      summary: List available MCP tools
      description: |
        Returns all available tools in MCP specification format.
        This endpoint implements the MCP `tools/list` method for tool discovery.

        Tools include:
        - miesc_run_audit: Execute comprehensive smart contract audit
        - miesc_correlate: Correlate findings from multiple tools
        - miesc_map_compliance: Map findings to compliance frameworks
        - miesc_remediate: Get remediation suggestions
        - miesc_generate_report: Generate audit report
        - miesc_quick_scan: Fast security scan
        - miesc_deep_scan: Comprehensive deep analysis
        - miesc_get_metrics: Get scientific validation metrics
        - miesc_get_status: Get system health status
        - miesc_analyze_defi: DeFi-specific security analysis
        - miesc_detect_exploit_chains: Detect exploit chains
      operationId: mcpToolsList
      parameters:
        - name: category
          in: query
          required: false
          schema:
            type: string
            enum: [static_analysis, dynamic_testing, symbolic_execution, formal_verification, ml_analysis, correlation, reporting, defi, fuzzing, config]
          description: Filter tools by category
        - name: extended
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Include extended tool metadata
      responses:
        '200':
          description: List of available tools in MCP format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MCPToolsListResponse'

  /mcp/tools/call:
    post:
      tags:
        - MCP Tools
      summary: Call an MCP tool
      description: |
        Invokes a specific MCP tool by name with provided arguments.
        This endpoint implements the MCP `tools/call` method.
      operationId: mcpToolsCall
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MCPToolCallRequest'
      responses:
        '200':
          description: Tool execution result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MCPToolCallResponse'
        '400':
          description: Invalid request (missing tool name or arguments)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Tool not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Tool execution error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /mcp/initialize:
    post:
      tags:
        - MCP Tools
      summary: MCP initialization handshake
      description: |
        Performs MCP protocol handshake and returns server capabilities.
        This endpoint implements the MCP `initialize` method.
      operationId: mcpInitialize
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MCPInitializeRequest'
      responses:
        '200':
          description: MCP capabilities and server info
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MCPInitializeResponse'

  /mcp/get_metrics:
    get:
      tags:
        - MCP
      summary: Get scientific metrics
      description: Returns scientific validation metrics from thesis experiments
      operationId: getMetrics
      responses:
        '200':
          description: Scientific metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetricsResponse'

  /mcp/run_audit:
    post:
      tags:
        - Analysis
      summary: Run contract audit
      description: Execute comprehensive smart contract security audit
      operationId: runAudit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuditRequest'
      responses:
        '200':
          description: Audit results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Contract not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /mcp/policy_audit:
    post:
      tags:
        - Analysis
      summary: Run policy audit
      description: Execute internal policy compliance validation
      operationId: runPolicyAudit
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PolicyAuditRequest'
      responses:
        '200':
          description: Policy audit results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PolicyAuditResponse'

  /mcp/stream/audit:
    get:
      tags:
        - Analysis
      summary: Stream audit results
      description: Server-sent events stream for real-time audit progress
      operationId: streamAudit
      parameters:
        - name: contract
          in: query
          required: true
          schema:
            type: string
          description: Path to contract file
      responses:
        '200':
          description: SSE stream of audit events
          content:
            text/event-stream:
              schema:
                type: string

  /mcp/defi/analyze:
    post:
      tags:
        - DeFi
      summary: DeFi security analysis
      description: Analyze DeFi-specific vulnerabilities (oracle manipulation, flash loans, etc.)
      operationId: defiAnalyze
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeFiAnalyzeRequest'
      responses:
        '200':
          description: DeFi analysis results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeFiAnalyzeResponse'
        '503':
          description: DeFi analyzer not available
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /mcp/correlate:
    post:
      tags:
        - Correlation
      summary: Correlate findings
      description: |
        Correlate findings from multiple security tools using Smart Correlation Engine.
        Deduplicates, cross-validates, and calculates confidence scores.
      operationId: correlateFindings
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CorrelateRequest'
      responses:
        '200':
          description: Correlated findings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CorrelateResponse'
        '503':
          description: Correlation engine not available
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /mcp/exploit-chains:
    post:
      tags:
        - Correlation
      summary: Detect exploit chains
      description: |
        Analyze correlated findings to detect exploit chains.
        An exploit chain is a combination of vulnerabilities that together
        create a more severe attack path than individual vulnerabilities.
      operationId: detectExploitChains
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CorrelateRequest'
      responses:
        '200':
          description: Exploit chain analysis
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExploitChainsResponse'
        '503':
          description: Correlation engine not available
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /mcp/remediate:
    post:
      tags:
        - Remediation
      summary: Get remediation suggestions
      description: |
        Enrich vulnerability findings with remediation suggestions,
        fix plans, and effort estimates.
      operationId: getRemediations
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RemediateRequest'
      responses:
        '200':
          description: Remediation report
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RemediateResponse'
        '503':
          description: Remediation engine not available
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /mcp/correlate-remediate:
    post:
      tags:
        - Correlation
        - Remediation
      summary: Correlate and remediate
      description: |
        Combined pipeline: correlate findings from multiple tools,
        then enrich with remediation suggestions.
      operationId: correlateAndRemediate
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CorrelateRemediateRequest'
      responses:
        '200':
          description: Correlated findings with remediations
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CorrelateRemediateResponse'
        '503':
          description: Required engines not available
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # ==========================================================================
  # PERSISTENCE LAYER (v4.1.0)
  # ==========================================================================
  /audits:
    get:
      tags:
        - Persistence
      summary: List audit records
      description: Returns paginated list of audit records from SQLite database
      operationId: listAudits
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
            maximum: 100
          description: Maximum number of records to return
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
          description: Number of records to skip
        - name: status
          in: query
          schema:
            type: string
            enum: [pending, running, completed, failed]
          description: Filter by audit status
      responses:
        '200':
          description: List of audits
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditListResponse'
    post:
      tags:
        - Persistence
      summary: Create audit record
      description: Creates a new audit record in the database
      operationId: createAudit
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateAuditRequest'
      responses:
        '201':
          description: Audit created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateAuditResponse'

  /audits/{audit_id}:
    get:
      tags:
        - Persistence
      summary: Get audit details
      description: Returns details of a specific audit record
      operationId: getAudit
      parameters:
        - name: audit_id
          in: path
          required: true
          schema:
            type: string
          description: Audit ID (e.g., audit-abc123)
      responses:
        '200':
          description: Audit details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditRecord'
        '404':
          description: Audit not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    patch:
      tags:
        - Persistence
      summary: Update audit status
      description: Updates the status and results of an audit
      operationId: updateAudit
      parameters:
        - name: audit_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateAuditRequest'
      responses:
        '200':
          description: Audit updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditRecord'

  /audits/{audit_id}/findings:
    get:
      tags:
        - Persistence
      summary: Get findings for audit
      description: Returns all findings associated with an audit
      operationId: getAuditFindings
      parameters:
        - name: audit_id
          in: path
          required: true
          schema:
            type: string
        - name: severity
          in: query
          schema:
            type: string
            enum: [critical, high, medium, low, informational]
          description: Filter by severity
      responses:
        '200':
          description: List of findings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FindingsListResponse'
    post:
      tags:
        - Persistence
      summary: Store findings
      description: Stores findings for an audit
      operationId: storeFindings
      parameters:
        - name: audit_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StoreFindingsRequest'
      responses:
        '201':
          description: Findings stored
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StoreFindingsResponse'

  /findings/{finding_id}/false-positive:
    patch:
      tags:
        - Persistence
      summary: Mark finding as false positive
      description: Updates a finding's false positive status
      operationId: markFalsePositive
      parameters:
        - name: finding_id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                is_false_positive:
                  type: boolean
      responses:
        '200':
          description: Finding updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                  finding_id:
                    type: string
                  is_false_positive:
                    type: boolean

  /statistics:
    get:
      tags:
        - Persistence
      summary: Get database statistics
      description: Returns aggregated statistics from the database
      operationId: getStatistics
      responses:
        '200':
          description: Statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatisticsResponse'

  /tool-statistics/{tool_name}:
    get:
      tags:
        - Persistence
      summary: Get tool performance statistics
      description: Returns performance metrics for a specific tool
      operationId: getToolStatistics
      parameters:
        - name: tool_name
          in: path
          required: true
          schema:
            type: string
          example: slither
      responses:
        '200':
          description: Tool statistics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ToolStatisticsResponse'

  # ==========================================================================
  # COMPLIANCE MAPPING (v4.1.0)
  # ==========================================================================
  /compliance/map:
    post:
      tags:
        - Compliance
      summary: Map finding to compliance frameworks
      description: |
        Maps a vulnerability finding to compliance frameworks:
        - SWC (Smart Contract Weakness Classification)
        - CWE (Common Weakness Enumeration)
        - ISO 27001:2022 controls
        - NIST CSF functions
        - OWASP Smart Contract Top 10
      operationId: mapFindingToCompliance
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ComplianceMapRequest'
      responses:
        '200':
          description: Compliance mapping
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ComplianceMapping'

  /compliance/report:
    post:
      tags:
        - Compliance
      summary: Generate compliance report
      description: |
        Generates a comprehensive compliance report from findings,
        including coverage analysis and gap identification.
      operationId: generateComplianceReport
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ComplianceReportRequest'
      responses:
        '200':
          description: Compliance report
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ComplianceReportResponse'

  /compliance/enrich:
    post:
      tags:
        - Compliance
      summary: Enrich findings with compliance data
      description: |
        Adds compliance metadata to vulnerability findings,
        preserving original data while adding SWC, CWE, ISO, NIST mappings.
      operationId: enrichFindingsCompliance
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/EnrichComplianceRequest'
      responses:
        '200':
          description: Enriched findings
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EnrichComplianceResponse'

  /compliance/gaps/iso27001:
    post:
      tags:
        - Compliance
      summary: Identify ISO 27001 gaps
      description: |
        Analyzes findings to identify gaps in ISO 27001:2022 control coverage.
        Returns unaddressed controls and recommendations.
      operationId: getISO27001Gaps
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ComplianceReportRequest'
      responses:
        '200':
          description: ISO 27001 gaps
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ISO27001GapsResponse'

  # ============= Exporters & Reports =============
  /export:
    post:
      tags:
        - Export
      summary: Export audit findings
      description: |
        Export audit findings to various formats for integration with external tools.
        Supported formats: SARIF (GitHub), SonarQube, Checkmarx, Markdown, JSON.
      operationId: exportFindings
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExportRequest'
      responses:
        '200':
          description: Exported report content
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExportResponse'
        '400':
          description: Invalid format or request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /export/formats:
    get:
      tags:
        - Export
      summary: List available export formats
      description: Returns all supported export formats with metadata
      operationId: listExportFormats
      responses:
        '200':
          description: Available formats
          content:
            application/json:
              schema:
                type: object
                properties:
                  formats:
                    type: array
                    items:
                      type: object
                      properties:
                        name:
                          type: string
                          examples: ["sarif", "sonarqube", "checkmarx", "markdown", "json"]
                        description:
                          type: string
                        content_type:
                          type: string
                        extension:
                          type: string

  # ============= Prometheus Metrics =============
  /metrics:
    get:
      tags:
        - Observability
      summary: Get Prometheus metrics
      description: |
        Returns metrics in Prometheus format for monitoring and alerting.
        Includes audit counts, tool execution times, findings by severity, etc.
      operationId: getPrometheusMetrics
      responses:
        '200':
          description: Prometheus metrics
          content:
            text/plain:
              schema:
                type: string
                examples:
                  - |
                    # HELP miesc_audits_total Total audits performed
                    # TYPE miesc_audits_total counter
                    miesc_audits_total{status="success"} 42
                    miesc_audits_total{status="error"} 3
            application/json:
              schema:
                $ref: '#/components/schemas/MetricsResponse'

  /metrics/json:
    get:
      tags:
        - Observability
      summary: Get metrics in JSON format
      description: Returns all collected metrics in JSON format
      operationId: getJsonMetrics
      responses:
        '200':
          description: JSON metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetricsResponse'

  # ============= WebSocket Real-Time API =============
  /ws:
    get:
      tags:
        - WebSocket
      summary: WebSocket connection info
      description: |
        Information about WebSocket real-time API for live audit updates.
        Connect via ws://host:port/ws/audit/{audit_id} for real-time events.
      operationId: getWebSocketInfo
      responses:
        '200':
          description: WebSocket connection information
          content:
            application/json:
              schema:
                type: object
                properties:
                  endpoint:
                    type: string
                    examples: ["ws://localhost:5001/ws/audit/{audit_id}"]
                  events:
                    type: array
                    items:
                      type: string
                    examples:
                      - ["audit_started", "audit_progress", "audit_completed", "tool_started", "finding_detected"]
                  documentation:
                    type: string

components:
  schemas:
    RootResponse:
      type: object
      properties:
        agent:
          type: string
          example: MIESC MCP REST Adapter
        version:
          type: string
          example: "4.0.0"
        status:
          type: string
          example: operational
        documentation:
          type: string
          example: /mcp/capabilities
        endpoints:
          type: object

    CapabilitiesResponse:
      type: object
      properties:
        agent_id:
          type: string
          example: miesc-agent-v4.0.0
        protocol:
          type: string
          example: mcp/1.0
        version:
          type: string
        capabilities:
          type: object
        metadata:
          type: object
          properties:
            scientific_validation:
              $ref: '#/components/schemas/ScientificValidation'

    StatusResponse:
      type: object
      properties:
        status:
          type: string
          enum: [operational, degraded, offline]
        agent_id:
          type: string
        version:
          type: string
        timestamp:
          type: string
          format: date-time
        health:
          type: object

    MetricsResponse:
      type: object
      properties:
        status:
          type: string
        metrics:
          $ref: '#/components/schemas/ScientificValidation'
        timestamp:
          type: string
          format: date-time

    ScientificValidation:
      type: object
      properties:
        precision:
          type: number
          example: 0.8947
        recall:
          type: number
          example: 0.862
        f1_score:
          type: number
          example: 0.8781
        cohens_kappa:
          type: number
          example: 0.847
        false_positive_reduction:
          type: number
          example: 0.43
        dataset_size:
          type: integer
          example: 5127

    AuditRequest:
      type: object
      required:
        - contract
      properties:
        contract:
          type: string
          description: Path to Solidity contract file
          example: contracts/MyToken.sol
        timeout:
          type: integer
          description: Analysis timeout in seconds
          default: 120
        layers:
          type: array
          items:
            type: integer
          description: Specific layers to run (1-7)

    AuditResponse:
      type: object
      properties:
        status:
          type: string
        contract:
          type: string
        audit_results:
          type: object
          properties:
            findings_count:
              type: integer
            severity_distribution:
              type: object
              properties:
                critical:
                  type: integer
                high:
                  type: integer
                medium:
                  type: integer
                low:
                  type: integer
            tools_executed:
              type: array
              items:
                type: string
        timestamp:
          type: string
          format: date-time

    PolicyAuditRequest:
      type: object
      properties:
        repo_path:
          type: string
          default: "."

    PolicyAuditResponse:
      type: object
      properties:
        status:
          type: string
        compliance_score:
          type: number
        passed:
          type: integer
        failed:
          type: integer
        total:
          type: integer
        checks:
          type: object
        report_path:
          type: string

    MLAnalyzeRequest:
      type: object
      required:
        - contract
      properties:
        contract:
          type: string
        mode:
          type: string
          enum: [quick, standard, deep]
          default: standard
        fp_threshold:
          type: number
          minimum: 0
          maximum: 1
          default: 0.6

    MLAnalyzeResponse:
      type: object
      properties:
        status:
          type: string
        risk_level:
          type: string
          enum: [CRITICAL, HIGH, MEDIUM, LOW]
        total_findings:
          type: integer
        fp_removed:
          type: integer
        reduction_rate:
          type: number
        clusters:
          type: array
          items:
            $ref: '#/components/schemas/VulnerabilityCluster'
        remediation_plan:
          type: array
          items:
            type: object
        execution_time_ms:
          type: number
        ml_processing_time_ms:
          type: number

    VulnerabilityCluster:
      type: object
      properties:
        category:
          type: string
        severity:
          type: string
        finding_count:
          type: integer
        remediation:
          type: string

    FeedbackRequest:
      type: object
      required:
        - finding_id
        - feedback_type
      properties:
        finding_id:
          type: string
        feedback_type:
          type: string
          enum: [TRUE_POSITIVE, FALSE_POSITIVE, SEVERITY_CORRECT, SEVERITY_TOO_HIGH, SEVERITY_TOO_LOW]
        notes:
          type: string
        user_id:
          type: string

    FeedbackResponse:
      type: object
      properties:
        status:
          type: string
        message:
          type: string

    MLReportResponse:
      type: object
      properties:
        fp_filter:
          type: object
        clusterer:
          type: object
        feedback:
          type: object
        recommendations:
          type: array
          items:
            type: object

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [healthy, degraded, unhealthy]
        healthy_tools:
          type: integer
        unhealthy_tools:
          type: integer
        tools:
          type: array
          items:
            type: object

    ToolsResponse:
      type: object
      properties:
        total:
          type: integer
        available:
          type: integer
        tools:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              layer:
                type: integer
              available:
                type: boolean

    ErrorResponse:
      type: object
      properties:
        status:
          type: string
          example: error
        message:
          type: string

    Finding:
      type: object
      properties:
        _id:
          type: string
        type:
          type: string
        severity:
          type: string
          enum: [critical, high, medium, low, informational]
        message:
          type: string
        location:
          type: object
          properties:
            file:
              type: string
            line:
              type: integer
            function:
              type: string
        tool:
          type: string
        swc_id:
          type: string
        cwe_id:
          type: string

    # DeFi Analysis
    DeFiAnalyzeRequest:
      type: object
      required:
        - contract
      properties:
        contract:
          type: string
          description: Path to Solidity contract file
        protocols:
          type: array
          items:
            type: string
            enum: [aave, compound, uniswap, balancer, curve]
          description: DeFi protocols to check for integration issues

    DeFiAnalyzeResponse:
      type: object
      properties:
        status:
          type: string
        contract:
          type: string
        defi_findings:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
              severity:
                type: string
              description:
                type: string
              recommendation:
                type: string
        timestamp:
          type: string
          format: date-time

    # Correlation
    CorrelateRequest:
      type: object
      required:
        - findings
      properties:
        findings:
          type: object
          additionalProperties:
            type: array
            items:
              $ref: '#/components/schemas/Finding'
          description: Map of tool_name to array of findings
          example:
            slither:
              - type: reentrancy
                severity: high
                message: Reentrancy in withdraw()
            aderyn:
              - type: unchecked-call
                severity: medium
                message: Return value ignored
        config:
          type: object
          properties:
            min_tools_for_validation:
              type: integer
              default: 2
            confidence_threshold:
              type: number
              default: 0.5
            fp_threshold:
              type: number
              default: 0.6

    CorrelateResponse:
      type: object
      properties:
        status:
          type: string
        correlated_findings:
          type: array
          items:
            $ref: '#/components/schemas/CorrelatedFinding'
        all_correlated:
          type: array
          items:
            $ref: '#/components/schemas/CorrelatedFinding'
        statistics:
          $ref: '#/components/schemas/CorrelationStatistics'
        high_confidence:
          type: array
          items:
            $ref: '#/components/schemas/CorrelatedFinding'
        cross_validated:
          type: array
          items:
            $ref: '#/components/schemas/CorrelatedFinding'
        timestamp:
          type: string
          format: date-time

    CorrelatedFinding:
      type: object
      properties:
        id:
          type: string
          example: CORR-abc123
        type:
          type: string
        severity:
          type: string
        message:
          type: string
        location:
          type: object
        swc_id:
          type: string
        confirming_tools:
          type: array
          items:
            type: string
        is_cross_validated:
          type: boolean
        confidence:
          type: object
          properties:
            base:
              type: number
            tool_agreement:
              type: number
            context:
              type: number
            ml:
              type: number
            final:
              type: number
        fp_probability:
          type: number

    CorrelationStatistics:
      type: object
      properties:
        total_correlated:
          type: integer
        original_findings:
          type: integer
        deduplication_rate:
          type: number
        cross_validated:
          type: integer
        high_confidence_count:
          type: integer
        average_confidence:
          type: number
        by_severity:
          type: object
        by_type:
          type: object

    # Exploit Chains
    ExploitChainsResponse:
      type: object
      properties:
        status:
          type: string
        exploit_chains:
          type: object
          properties:
            summary:
              $ref: '#/components/schemas/ExploitChainSummary'
            chains:
              type: array
              items:
                $ref: '#/components/schemas/ExploitChain'
            critical_chains:
              type: array
              items:
                $ref: '#/components/schemas/ExploitChain'
            high_impact_chains:
              type: array
              items:
                $ref: '#/components/schemas/ExploitChain'
        correlated_findings:
          type: array
          items:
            $ref: '#/components/schemas/CorrelatedFinding'
        timestamp:
          type: string
          format: date-time

    ExploitChain:
      type: object
      properties:
        id:
          type: string
          example: CHAIN-abc123
        name:
          type: string
          example: Fund Drain Attack
        description:
          type: string
        severity:
          type: string
          enum: [critical, high, medium]
        base_cvss:
          type: number
          example: 9.8
        chain:
          type: object
          properties:
            vulnerabilities:
              type: array
              items:
                type: string
            vuln_types:
              type: array
              items:
                type: string
            length:
              type: integer
        attack_vector:
          type: string
          enum: [external, internal, privileged]
        scores:
          type: object
          properties:
            exploitability:
              type: number
            impact:
              type: number
            combined:
              type: number
        complexity:
          type: string
          enum: [low, medium, high]
        affected:
          type: object
          properties:
            files:
              type: array
              items:
                type: string
            functions:
              type: array
              items:
                type: string

    ExploitChainSummary:
      type: object
      properties:
        total_chains:
          type: integer
        by_severity:
          type: object
        critical_count:
          type: integer
        high_count:
          type: integer
        average_cvss:
          type: number
        max_cvss:
          type: number
        chain_names:
          type: array
          items:
            type: string

    # Remediation
    RemediateRequest:
      type: object
      required:
        - findings
      properties:
        findings:
          type: array
          items:
            $ref: '#/components/schemas/Finding'
        contract_name:
          type: string
          default: Contract
        source_code:
          type: string
          description: Optional source code for checklist analysis

    RemediateResponse:
      type: object
      properties:
        status:
          type: string
        report:
          $ref: '#/components/schemas/RemediationReport'
        timestamp:
          type: string
          format: date-time

    RemediationReport:
      type: object
      properties:
        contract:
          type: string
        summary:
          type: object
          properties:
            total:
              type: integer
            critical:
              type: integer
            high:
              type: integer
            medium:
              type: integer
            low:
              type: integer
        findings:
          type: array
          items:
            $ref: '#/components/schemas/EnrichedFinding'
        fix_plan:
          type: array
          items:
            $ref: '#/components/schemas/FixPlanStep'
        estimated_effort:
          type: string
          example: "~4 hours"
        checklist_status:
          type: object
          additionalProperties:
            type: boolean

    EnrichedFinding:
      type: object
      properties:
        id:
          type: string
        type:
          type: string
        severity:
          type: string
        message:
          type: string
        swc_id:
          type: string
        fix:
          type: object
          properties:
            effort:
              type: string
              enum: [trivial, low, medium, high, complex]
            risk:
              type: string
              enum: [safe, low, medium, high]
        priority:
          type: object
          properties:
            score:
              type: number
            rank:
              type: integer
        remediation:
          type: object
          properties:
            title:
              type: string
            description:
              type: string
            example_vulnerable:
              type: string
            example_fixed:
              type: string
            references:
              type: array
              items:
                type: string

    FixPlanStep:
      type: object
      properties:
        step:
          type: integer
        swc_id:
          type: string
        action:
          type: string
        example:
          type: string

    # Combined Correlation + Remediation
    CorrelateRemediateRequest:
      type: object
      required:
        - findings
      properties:
        findings:
          type: object
          additionalProperties:
            type: array
            items:
              $ref: '#/components/schemas/Finding'
        contract_name:
          type: string
          default: Contract
        config:
          type: object
          properties:
            min_tools_for_validation:
              type: integer
              default: 2
            confidence_threshold:
              type: number
              default: 0.5

    CorrelateRemediateResponse:
      type: object
      properties:
        status:
          type: string
        correlation:
          $ref: '#/components/schemas/CorrelateResponse'
        remediation:
          $ref: '#/components/schemas/RemediationReport'
        timestamp:
          type: string
          format: date-time

    # ==========================================================================
    # MCP TOOL DISCOVERY SCHEMAS (v4.1.0)
    # ==========================================================================
    MCPToolsListResponse:
      type: object
      properties:
        tools:
          type: array
          items:
            $ref: '#/components/schemas/MCPTool'
      example:
        tools:
          - name: miesc_run_audit
            description: Execute comprehensive smart contract security audit
            inputSchema:
              type: object
              properties:
                contract:
                  type: string
                timeout:
                  type: integer
              required:
                - contract

    MCPTool:
      type: object
      required:
        - name
        - description
        - inputSchema
      properties:
        name:
          type: string
          example: miesc_run_audit
        description:
          type: string
          example: Execute comprehensive smart contract security audit
        inputSchema:
          type: object
          properties:
            type:
              type: string
              enum: [object]
            properties:
              type: object
            required:
              type: array
              items:
                type: string

    MCPToolCallRequest:
      type: object
      required:
        - name
        - arguments
      properties:
        name:
          type: string
          description: Tool name to invoke
          example: miesc_run_audit
        arguments:
          type: object
          description: Tool arguments
          example:
            contract: contracts/Token.sol
            timeout: 120

    MCPToolCallResponse:
      type: object
      properties:
        content:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
                enum: [text]
              text:
                type: string
        isError:
          type: boolean
          default: false

    MCPInitializeRequest:
      type: object
      properties:
        protocolVersion:
          type: string
          example: "2024-11-05"
        capabilities:
          type: object
        clientInfo:
          type: object
          properties:
            name:
              type: string
            version:
              type: string

    MCPInitializeResponse:
      type: object
      properties:
        protocolVersion:
          type: string
          example: "2024-11-05"
        capabilities:
          type: object
          properties:
            tools:
              type: object
              properties:
                listChanged:
                  type: boolean
            experimental:
              type: object
              properties:
                miesc:
                  type: object
                  properties:
                    version:
                      type: string
                      example: "4.1.0"
                    layers:
                      type: integer
                      example: 7
        serverInfo:
          type: object
          properties:
            name:
              type: string
              example: miesc-mcp-server
            version:
              type: string
              example: "4.1.0"

    # ==========================================================================
    # PERSISTENCE LAYER SCHEMAS (v4.1.0)
    # ==========================================================================
    AuditRecord:
      type: object
      properties:
        audit_id:
          type: string
          example: audit-abc123def456
        contract_path:
          type: string
          example: /contracts/Token.sol
        contract_hash:
          type: string
          description: SHA256 hash of contract content
        status:
          type: string
          enum: [pending, running, completed, failed]
        tools_requested:
          type: array
          items:
            type: string
          example: [slither, mythril, aderyn]
        tools_success:
          type: array
          items:
            type: string
        tools_failed:
          type: array
          items:
            type: string
        total_findings:
          type: integer
        findings_by_severity:
          type: object
          properties:
            critical:
              type: integer
            high:
              type: integer
            medium:
              type: integer
            low:
              type: integer
        execution_time_ms:
          type: number
        created_at:
          type: string
          format: date-time
        completed_at:
          type: string
          format: date-time

    AuditListResponse:
      type: object
      properties:
        audits:
          type: array
          items:
            $ref: '#/components/schemas/AuditRecord'
        total:
          type: integer
        limit:
          type: integer
        offset:
          type: integer

    CreateAuditRequest:
      type: object
      required:
        - contract_path
        - tools
      properties:
        contract_path:
          type: string
          example: /contracts/Token.sol
        tools:
          type: array
          items:
            type: string
          example: [slither, mythril]

    CreateAuditResponse:
      type: object
      properties:
        status:
          type: string
          example: created
        audit_id:
          type: string
          example: audit-abc123def456

    UpdateAuditRequest:
      type: object
      properties:
        status:
          type: string
          enum: [pending, running, completed, failed]
        results:
          type: object
          properties:
            tools_success:
              type: array
              items:
                type: string
            tools_failed:
              type: array
              items:
                type: string
            total_findings:
              type: integer
            findings_by_severity:
              type: object
            execution_time_ms:
              type: number

    FindingRecord:
      type: object
      properties:
        finding_id:
          type: string
          example: find-xyz789
        audit_id:
          type: string
        tool:
          type: string
        type:
          type: string
        severity:
          type: string
          enum: [critical, high, medium, low, informational]
        title:
          type: string
        description:
          type: string
        confidence:
          type: number
        swc_id:
          type: string
        cwe_id:
          type: string
        is_false_positive:
          type: boolean
          default: false
        created_at:
          type: string
          format: date-time

    FindingsListResponse:
      type: object
      properties:
        findings:
          type: array
          items:
            $ref: '#/components/schemas/FindingRecord'
        total:
          type: integer

    StoreFindingsRequest:
      type: object
      required:
        - findings
      properties:
        findings:
          type: array
          items:
            $ref: '#/components/schemas/Finding'

    StoreFindingsResponse:
      type: object
      properties:
        status:
          type: string
          example: stored
        count:
          type: integer
          description: Number of findings stored

    StatisticsResponse:
      type: object
      properties:
        total_audits:
          type: integer
        total_findings:
          type: integer
        findings_by_severity:
          type: object
          properties:
            critical:
              type: integer
            high:
              type: integer
            medium:
              type: integer
            low:
              type: integer
        false_positive_rate:
          type: number
        average_findings_per_audit:
          type: number

    ToolStatisticsResponse:
      type: object
      additionalProperties:
        type: object
        properties:
          total_runs:
            type: integer
          success_rate:
            type: number
          average_execution_time_ms:
            type: number
          total_findings:
            type: integer

    # ==========================================================================
    # COMPLIANCE MAPPING SCHEMAS (v4.1.0)
    # ==========================================================================
    ComplianceMapRequest:
      type: object
      required:
        - finding
      properties:
        finding:
          type: object
          properties:
            type:
              type: string
              example: reentrancy
            severity:
              type: string
            swc_id:
              type: string
              description: Optional existing SWC ID

    ComplianceMapping:
      type: object
      properties:
        swc_id:
          type: string
          example: SWC-107
        swc_title:
          type: string
          example: Reentrancy
        cwe_ids:
          type: array
          items:
            type: string
          example: [CWE-841]
        iso27001_controls:
          type: array
          items:
            type: string
          example: [A.8.26, A.8.28]
          description: ISO 27001:2022 control references
        nist_csf_functions:
          type: array
          items:
            type: string
          example: [PR.DS-1, DE.CM-4]
        owasp_sc_categories:
          type: array
          items:
            type: string
          example: [SC01]
          description: OWASP Smart Contract Top 10 categories
        compliance_score:
          type: number
          minimum: 0
          maximum: 1
          description: Coverage score for this vulnerability

    ComplianceReportRequest:
      type: object
      required:
        - findings
      properties:
        findings:
          type: array
          items:
            $ref: '#/components/schemas/Finding'

    ComplianceReportResponse:
      type: object
      properties:
        status:
          type: string
        report:
          type: object
          properties:
            total_findings:
              type: integer
            mapped_findings:
              type: integer
            overall_score:
              type: number
              minimum: 0
              maximum: 1
            coverage_by_framework:
              type: object
              properties:
                ISO27001:
                  type: number
                NIST_CSF:
                  type: number
                OWASP_SC:
                  type: number
            mappings:
              type: array
              items:
                $ref: '#/components/schemas/ComplianceMapping'
        timestamp:
          type: string
          format: date-time

    EnrichComplianceRequest:
      type: object
      required:
        - findings
      properties:
        findings:
          type: array
          items:
            $ref: '#/components/schemas/Finding'

    EnrichComplianceResponse:
      type: object
      properties:
        status:
          type: string
        enriched_findings:
          type: array
          items:
            type: object
            properties:
              type:
                type: string
              severity:
                type: string
              compliance:
                $ref: '#/components/schemas/ComplianceMapping'

    ISO27001GapsResponse:
      type: object
      properties:
        status:
          type: string
        gaps:
          type: array
          items:
            type: object
            properties:
              framework:
                type: string
                example: ISO27001
              control:
                type: string
                example: A.8.26
              title:
                type: string
              status:
                type: string
                enum: [not_addressed, partially_addressed]
              recommendation:
                type: string
        addressed_controls:
          type: array
          items:
            type: string
        total_controls:
          type: integer
        coverage_percentage:
          type: number

    # ============= Export Schemas =============
    ExportRequest:
      type: object
      required:
        - findings
        - format
      properties:
        findings:
          type: array
          items:
            $ref: '#/components/schemas/Finding'
        format:
          type: string
          enum: [sarif, sonarqube, checkmarx, markdown, json]
          description: Export format
        include_remediation:
          type: boolean
          default: false
        include_metadata:
          type: boolean
          default: true

    ExportResponse:
      type: object
      properties:
        status:
          type: string
        format:
          type: string
        content:
          type: string
          description: Exported content (may be JSON, XML, or Markdown)
        content_type:
          type: string
          examples: ["application/json", "text/markdown", "application/xml"]

    # ============= Metrics Schemas =============
    MetricsResponse:
      type: object
      properties:
        counters:
          type: object
          additionalProperties:
            type: number
          description: Counter metrics (audits, findings, etc.)
        gauges:
          type: object
          additionalProperties:
            type: number
          description: Gauge metrics (active audits, etc.)
        histograms:
          type: object
          additionalProperties:
            type: object
            properties:
              count:
                type: integer
              sum:
                type: number
              buckets:
                type: array
                items:
                  type: number
          description: Histogram metrics (latencies, durations)
        recent:
          type: array
          items:
            type: object
            properties:
              name:
                type: string
              type:
                type: string
              value:
                type: number
              timestamp:
                type: string
                format: date-time
